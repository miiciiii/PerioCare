{% extends "base/index.html" %}
{% load static %}

{% block title %}Chat - PerioCare AI{% endblock %}

{% block content %}
<div class="container py-5">
  <!-- Title -->
  <h2 class="mb-4 text-center text-primary">Chat in Progress</h2>

  <!-- Chat Box -->
  <div class="card shadow-sm border-0">
    <div class="card-body bg-light rounded" id="chatBox" style="height: 350px; overflow-y: auto;">
      {% if initial_message %}
      <div class="text-start mb-2">
        <span class="badge bg-success">AI: {{ initial_message }}</span>
      </div>
      {% else %}
      <div class="text-muted text-center">Conversation startedâ€¦</div>
      {% endif %}
    </div>
  </div>

  <!-- Input Area -->
  <form id="chatForm" method="post" class="mt-3">
    {% csrf_token %}
    <div class="input-group">
      <input
        type="text"
        class="form-control"
        id="userInput"
        placeholder="Speak or type your messageâ€¦"
        required
      />
      <button type="button" id="micButton" class="btn btn-outline-secondary" title="Start voice input">
        <i class="bi bi-mic"></i>
      </button>
      <button type="submit" class="btn btn-primary">Send</button>
    </div>
  </form>

  <!-- Finish Button -->
  <div class="text-center mt-4">
    <a href="{% url 'response' %}" class="btn btn-outline-dark">Finish Call</a>
  </div>
</div>

<script>
const chatBox = document.getElementById('chatBox');
const userInput = document.getElementById('userInput');
const micButton = document.getElementById('micButton');
const chatForm = document.getElementById('chatForm');

// ðŸŽ¤ SPEECH-TO-TEXT
micButton.addEventListener('click', () => {
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'en-US';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.start();

    recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        userInput.value = transcript;
    };

    recognition.onerror = (event) => {
        alert('Speech recognition error: ' + event.error);
    };
});

// ðŸ“¨ FORM SUBMIT
chatForm.addEventListener('submit', function(e) {
    e.preventDefault();

    const message = userInput.value.trim();
    if (!message) return;

    // Append user's message
    const userMsg = document.createElement('div');
    userMsg.className = 'text-end mb-2';
    userMsg.innerHTML = `<span class="badge bg-primary">${message}</span>`;
    chatBox.appendChild(userMsg);
    chatBox.scrollTop = chatBox.scrollHeight;

    userInput.value = '';

    // Send to unified AI endpoint
    fetch("{% url 'ai_response' %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/json",
        },
        body: JSON.stringify({ message })
    })
    .then(response => response.json())
    .then(data => {
        const aiText = data.reply || "AI did not respond.";

        // Append AI message
        const aiMsg = document.createElement('div');
        aiMsg.className = 'text-start mb-2';
        aiMsg.innerHTML = `<span class="badge bg-success">AI: ${aiText}</span>`;
        chatBox.appendChild(aiMsg);
        chatBox.scrollTop = chatBox.scrollHeight;

        // ðŸ”Š Text-to-speech
        const synth = window.speechSynthesis;
        const utterance = new SpeechSynthesisUtterance(aiText);
        utterance.lang = 'en-US';
        synth.speak(utterance);
    });
});
</script>

{% endblock %}
